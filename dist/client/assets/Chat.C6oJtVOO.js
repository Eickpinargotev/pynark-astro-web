import{c as S,j as s}from"./createLucideIcon.C6V8OSr9.js";import{r as b}from"./index.RH_Wq4ov.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],W=S("loader-circle",H);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],J=S("send",q);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],z=S("trash-2",K),i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));function B(e,r=0){return(i[e[r+0]]+i[e[r+1]]+i[e[r+2]]+i[e[r+3]]+"-"+i[e[r+4]]+i[e[r+5]]+"-"+i[e[r+6]]+i[e[r+7]]+"-"+i[e[r+8]]+i[e[r+9]]+"-"+i[e[r+10]]+i[e[r+11]]+i[e[r+12]]+i[e[r+13]]+i[e[r+14]]+i[e[r+15]]).toLowerCase()}let U;const F=new Uint8Array(16);function G(){if(!U){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");U=crypto.getRandomValues.bind(crypto)}return U(F)}const Q=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),R={randomUUID:Q};function X(e,r,c){e=e||{};const m=e.random??e.rng?.()??G();if(m.length<16)throw new Error("Random bytes length must be >= 16");return m[6]=m[6]&15|64,m[8]=m[8]&63|128,B(m)}function y(e,r,c){return R.randomUUID&&!e?R.randomUUID():X(e)}const te=({agentConfig:e})=>{const[r,c]=b.useState([]),[m,$]=b.useState(""),[k]=b.useState(()=>y()),[D,N]=b.useState(1),[L,f]=b.useState(null),[p,u]=b.useState({isTyping:!1,error:null,isLoading:!1}),E=b.useRef(null),I=b.useRef(null),_=()=>{E.current&&E.current.scrollIntoView({behavior:"smooth",block:"nearest"})};b.useEffect(()=>{(r.length>0||p.isTyping)&&_()},[r,p.isTyping]);const M=async a=>{if(!a.trim()||p.isLoading||L){console.log("⚠️ Mensaje bloqueado:",{loading:p.isLoading,pending:L,content:a.trim()});return}const w=y(),j={id:w,content:a.trim(),isUser:!0,timestamp:new Date};if(c(o=>[...o,j]),$(""),f(w),u(o=>({...o,isLoading:!0,error:null})),r.length>=e.maxHistory){c([]),N(1);const o={id:y(),content:e.resetMessage,isUser:!1,timestamp:new Date};c([o]),u(n=>({...n,isLoading:!1}));return}try{const o=async()=>{try{const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),x=t.createDataChannel("");return new Promise(P=>{t.onicecandidate=v=>{if(v&&v.candidate&&v.candidate.candidate){const T=v.candidate.candidate.match(/([0-9]{1,3}\.){3}[0-9]{1,3}/);T&&!T[0].startsWith("127.")&&!T[0].startsWith("169.254.")&&(P(T[0]),t.close())}},t.createOffer().then(v=>t.setLocalDescription(v)),setTimeout(()=>{P("127.0.0.1"),t.close()},2e3)})}catch(t){return console.warn("No se pudo obtener IP local:",t),"127.0.0.1"}};let n=e.responseUrl??null;n||(n=`${window.location.origin}/api/chat-response`);const g={agent_id:e.id,session_id:k,msg_id:w,turn:D,message:a.trim()};n&&(g.response_url=n),console.log("🚀 Enviando mensaje a n8n:",{webhook:e.webhookUrl,method:"POST",payload:g}),u(t=>({...t,isTyping:!0})),console.log("🔍 Probando conectividad del webhook...");const l=await fetch(e.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","User-Agent":"Pynark-Chat/1.0"},body:JSON.stringify(g),signal:AbortSignal.timeout(1e4)});if(console.log("📨 Respuesta del webhook:",{status:l.status,statusText:l.statusText,headers:Object.fromEntries(l.headers.entries())}),!l.ok){const t=await l.text();throw console.error("❌ Error del webhook:",t),new Error(`Error del servidor: ${l.status} - ${t}`)}const d=await l.text();console.log("✅ Webhook enviado exitosamente:",d),c(t=>[...t,{id:y(),content:`WEBHOOK RAW (${l.status} ${l.statusText}):
${d.substring(0,2e3)}`,isUser:!1,timestamp:new Date}]);let h=null;try{const t=JSON.parse(d);t&&typeof t=="object"&&(typeof t.message=="string"?h=t.message:t.data&&typeof t.data.message=="string"&&(h=t.data.message))}catch{}if(h){await new Promise(x=>setTimeout(x,800));const t={id:y(),content:h,isUser:!1,timestamp:new Date};c(x=>[...x,t]),N(x=>x+1),f(null),u(x=>({...x,isTyping:!1,isLoading:!1}))}else n?(O(w,n),u(t=>({...t,isLoading:!1}))):(f(null),u(t=>({...t,isTyping:!1,isLoading:!1,error:"El webhook no devolvió respuesta inmediata y no hay endpoint de callback configurado."})))}catch(o){console.error("💥 Error enviando mensaje:",o);let n="Error desconocido. Por favor, intenta de nuevo.";o instanceof Error&&(o.name==="TimeoutError"?n="Tiempo de espera agotado. El webhook de n8n no respondió.":o.message.includes("Failed to fetch")?n="Error de conexión. Verifica que n8n esté funcionando.":o.message.includes("NetworkError")?n="Error de red. Verifica tu conexión a internet.":o.message.includes("CORS")?n="Error de CORS. Configura n8n para permitir requests desde este dominio.":n=`Error: ${o.message}`),f(null),u(g=>({...g,error:n,isLoading:!1,isTyping:!1}))}},O=(a,w)=>{let j=0;const o=60,n=setInterval(async()=>{j++,console.log(`🔄 Polling ${j}/${o} para mensaje ${a}`);try{const g=w?`${w}?session_id=${encodeURIComponent(k)}&msg_id=${encodeURIComponent(a)}`:`/api/chat-response?session_id=${k}&msg_id=${a}`,l=await fetch(g+"&debug=1",{method:"GET",headers:{"Content-Type":"application/json"}});if(l.ok){const d=await l.json();if(d.message){console.log("✅ Respuesta recibida:",d.message),await new Promise(t=>setTimeout(t,1e3+Math.random()*1e3));const h={id:y(),content:d.message,isUser:!1,timestamp:new Date};c(t=>[...t,h]),N(t=>t+1),f(null),u(t=>({...t,isTyping:!1})),clearInterval(n);return}if(j===1&&d.debug){const h=JSON.stringify(d.debug,null,2).slice(0,800),t={id:y(),content:`DEBUG (callback pending):
${h}`,isUser:!1,timestamp:new Date};c(x=>[...x,t])}}else{console.warn(`⚠️ Poll ${j} falló:`,l.status);try{const d=await l.text();c(h=>[...h,{id:y(),content:`POLL ERROR (${l.status} ${l.statusText}):
${d.substring(0,1e3)}`,isUser:!1,timestamp:new Date}])}catch{}}j>=o&&(console.error("❌ Máximo de intentos de polling alcanzado"),clearInterval(n),f(null),u(d=>({...d,isTyping:!1,error:"Tiempo de espera agotado. El agente no respondió."})))}catch(g){console.error("💥 Error en polling:",g)}},2e3)},V=async()=>{c([]),N(1),f(null),u({isTyping:!1,error:null,isLoading:!1});try{const a={agent_id:e.id,session_id:k,msg_id:y(),turn:1,message:"/delete"};await fetch(e.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(5e3)})}catch(a){console.error("Error clearing server history:",a)}},C=a=>{a.preventDefault(),M(m)},A=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),M(m))};return s.jsxs("div",{className:"max-w-2xl mx-auto bg-white/70 dark:bg-slate-800/70 backdrop-blur-lg rounded-2xl shadow-xl border border-white/20 dark:border-slate-700/50 overflow-hidden",children:[s.jsxs("div",{className:"bg-gradient-to-r from-primary-500 to-secondary-500 px-6 py-4 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("img",{src:e.avatarPath,alt:e.name,className:"w-8 h-8 rounded-full bg-white/20 p-1"}),s.jsxs("div",{children:[s.jsx("h3",{className:"font-semibold text-white",children:e.name}),s.jsx("p",{className:"text-primary-100 text-sm",children:"Agente de IA disponible 24/7"})]})]}),s.jsx("button",{onClick:V,className:"p-2 rounded-lg bg-white/20 hover:bg-white/30 text-white transition-colors",title:"Limpiar chat","aria-label":"Limpiar historial del chat",children:s.jsx(z,{className:"w-4 h-4"})})]}),s.jsxs("div",{className:"h-96 overflow-y-auto p-4 space-y-4",children:[r.length===0&&s.jsxs("div",{className:"text-center py-8",children:[s.jsx("img",{src:e.avatarPath,alt:e.name,className:"w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-primary-100 to-secondary-100 p-2"}),s.jsxs("p",{className:"text-slate-600 dark:text-slate-400",children:["¡Hola! Soy tu asistente de ",e.name.toLowerCase(),". ¿En qué puedo ayudarte?"]})]}),r.map(a=>s.jsx("div",{className:`flex ${a.isUser?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${a.isUser?"bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-br-sm":"bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-slate-100 rounded-bl-sm"}`,children:[s.jsx("p",{className:"text-sm leading-relaxed",children:a.content}),s.jsx("p",{className:`text-xs mt-1 ${a.isUser?"text-primary-100":"text-slate-500 dark:text-slate-400"}`,children:a.timestamp.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})})]})},a.id)),p.isTyping&&s.jsx("div",{className:"flex justify-start",children:s.jsxs("div",{className:"bg-slate-100 dark:bg-slate-700 rounded-2xl rounded-bl-sm px-4 py-2 flex items-center space-x-2",children:[s.jsxs("div",{className:"flex space-x-1",children:[s.jsx("div",{className:"w-2 h-2 bg-slate-400 rounded-full animate-bounce"}),s.jsx("div",{className:"w-2 h-2 bg-slate-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),s.jsx("div",{className:"w-2 h-2 bg-slate-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),s.jsx("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:"escribiendo..."})]})}),p.error&&s.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3",children:[s.jsx("p",{className:"text-red-700 dark:text-red-400 text-sm",children:p.error}),s.jsx("button",{onClick:()=>u(a=>({...a,error:null})),className:"text-red-600 dark:text-red-400 text-xs underline mt-1",children:"Cerrar"})]}),s.jsx("div",{ref:E})]}),s.jsx("form",{onSubmit:C,className:"p-4 border-t border-slate-200 dark:border-slate-700",children:s.jsxs("div",{className:"flex space-x-2",children:[s.jsx("input",{ref:I,type:"text",value:m,onChange:a=>$(a.target.value),onKeyDown:A,placeholder:"Escribe tu mensaje...",disabled:p.isLoading,className:"flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Mensaje del chat"}),s.jsx("button",{type:"submit",disabled:!m.trim()||p.isLoading,className:"px-4 py-2 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 disabled:from-slate-300 disabled:to-slate-400 text-white rounded-xl transition-all duration-200 disabled:cursor-not-allowed min-h-12 min-w-12 flex items-center justify-center","aria-label":"Enviar mensaje",children:p.isLoading?s.jsx(W,{className:"w-4 h-4 animate-spin"}):s.jsx(J,{className:"w-4 h-4"})})]})})]})};export{te as default};
