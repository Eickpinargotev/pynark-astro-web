---
import Layout from '../layouts/Layout.astro';
import Chat from '../components/Chat.tsx';
import ChatSimulation from '../components/ChatSimulation.tsx';

// Load agent configuration
import ecommerceAgent from '../../agents/ecomerce_test.json';
import drivingSchoolAgent from '../../agents/escuela_manejo.json';
---

<Layout title="Pynark Automation - Chatbots que Convierten">
  <!-- Hero Section -->
  <section class="py-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto text-center">
      <h1 class="font-display text-4xl sm:text-5xl lg:text-6xl font-bold text-slate-900 dark:text-white mb-6">
        Chatbots que convierten <br class="hidden sm:block">
        <span class="bg-gradient-to-r from-primary-600 to-secondary-600 bg-clip-text text-transparent">
          visitas en ventas y citas
        </span>
      </h1>
      <p class="text-xl text-slate-600 dark:text-slate-300 mb-12 max-w-3xl mx-auto">
        Especialistas en agentes de servicio al cliente que funcionan 24/7 para hacer crecer tu negocio.
      </p>
    </div>
  </section>

  <!-- Chat Section -->
  <section class="py-16 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-primary-50/50 to-secondary-50/50 dark:from-primary-900/10 dark:to-secondary-900/10">
    <div class="max-w-7xl mx-auto text-center">
      <div id="chat-section">
        <button 
          id="show-agents-btn"
          class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-primary-600 to-secondary-600 hover:from-primary-700 hover:to-secondary-700 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300"
        >
          PRUEBA NUESTROS AGENTES
        </button>
        
        <div id="agent-buttons" class="hidden mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <button 
            id="ecommerce-btn"
            class="inline-flex items-center justify-center px-6 py-3 bg-white dark:bg-slate-800 text-slate-900 dark:text-white font-medium rounded-xl shadow-lg hover:shadow-xl border border-slate-200 dark:border-slate-700 hover:border-primary-300 dark:hover:border-primary-600 transition-all duration-300"
          >
            E-commerce Test
          </button>
          <button 
            id="driving-btn"
            class="inline-flex items-center justify-center px-6 py-3 bg-white dark:bg-slate-800 text-slate-900 dark:text-white font-medium rounded-xl shadow-lg hover:shadow-xl border border-slate-200 dark:border-slate-700 hover:border-primary-300 dark:hover:border-primary-600 transition-all duration-300"
          >
            Escuela de Manejo
          </button>
        </div>

        <div id="chat-container" class="hidden mt-8 space-y-8">
          <div id="chat-ecommerce" class="hidden">
            <Chat client:load agentConfig={ecommerceAgent} />
          </div>
          <div id="chat-driving" class="hidden">
            <Chat client:load agentConfig={drivingSchoolAgent} />
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- How We Work Section -->
  <section class="py-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <h2 class="font-display text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white mb-6">
          Cómo trabajamos
        </h2>
      </div>
      
      <div class="relative">
        <!-- Timeline line - Desktop -->
        <div class="hidden md:block absolute left-1/2 transform -translate-x-px h-full w-0.5 bg-gradient-to-b from-primary-400 to-secondary-400"></div>
        
        <!-- Timeline line - Mobile -->
        <div class="md:hidden absolute left-8 top-0 h-full w-0.5 bg-gradient-to-b from-primary-400 to-secondary-400"></div>
        
        <!-- Timeline items -->
        <div class="space-y-12 md:space-y-16">
          <!-- Step 1 -->
          <div class="relative flex items-center">
            <!-- Mobile Layout -->
            <div class="md:hidden flex items-start">
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg z-10">
                <span class="text-white font-bold">1</span>
              </div>
              <div class="ml-6 flex-1">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Diagnóstico
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Sesión de 30-45 minutos para entender tu negocio y necesidades específicas
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden md:flex md:items-center w-full">
              <div class="flex-1 pr-8 text-right">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Diagnóstico
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Sesión de 30-45 minutos para entender tu negocio y necesidades específicas
                  </p>
                </div>
              </div>
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg">
                <span class="text-white font-bold">1</span>
              </div>
              <div class="flex-1 pl-8"></div>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="relative flex items-center">
            <!-- Mobile Layout -->
            <div class="md:hidden flex items-start">
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg z-10">
                <span class="text-white font-bold">2</span>
              </div>
              <div class="ml-6 flex-1">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Setup de vertical
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Configuración personalizada del agente en 2-5 días según tu industria
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden md:flex md:items-center w-full">
              <div class="flex-1 pr-8"></div>
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg">
                <span class="text-white font-bold">2</span>
              </div>
              <div class="flex-1 pl-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Setup de vertical
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Configuración personalizada del agente en 2-5 días según tu industria
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="relative flex items-center">
            <!-- Mobile Layout -->
            <div class="md:hidden flex items-start">
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg z-10">
                <span class="text-white font-bold">3</span>
              </div>
              <div class="ml-6 flex-1">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Go-live con monitoreo
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Lanzamiento con supervisión activa para garantizar el rendimiento óptimo
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden md:flex md:items-center w-full">
              <div class="flex-1 pr-8 text-right">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Go-live con monitoreo
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Lanzamiento con supervisión activa para garantizar el rendimiento óptimo
                  </p>
                </div>
              </div>
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg">
                <span class="text-white font-bold">3</span>
              </div>
              <div class="flex-1 pl-8"></div>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="relative flex items-center">
            <!-- Mobile Layout -->
            <div class="md:hidden flex items-start">
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg z-10">
                <span class="text-white font-bold">4</span>
              </div>
              <div class="ml-6 flex-1">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Optimización mensual
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Reportes detallados con insights y mejoras continuas del rendimiento
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden md:flex md:items-center w-full">
              <div class="flex-1 pr-8"></div>
              <div class="relative flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full border-4 border-white dark:border-slate-900 shadow-lg">
                <span class="text-white font-bold">4</span>
              </div>
              <div class="flex-1 pl-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                  <h3 class="font-display text-xl font-semibold text-slate-900 dark:text-white mb-2">
                    Optimización mensual
                  </h3>
                  <p class="text-slate-600 dark:text-slate-300">
                    Reportes detallados con insights y mejoras continuas del rendimiento
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Examples Section -->
  <section class="py-20 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-slate-50 to-primary-50/30 dark:from-slate-900 dark:to-primary-900/10">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <h2 class="font-display text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white mb-6">
          Ejemplos en acción
        </h2>
        <p class="text-xl text-slate-600 dark:text-slate-300 max-w-3xl mx-auto">
          Descubre cómo nuestros agentes manejan diferentes situaciones reales de negocio
        </p>
      </div>
      
      <ChatSimulation client:load />
    </div>
  </section>

  <!-- Contact Section -->
  <section id="contact" class="py-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-12">
        <h2 class="font-display text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white mb-6">
          Contáctanos
        </h2>
        <p class="text-xl text-slate-600 dark:text-slate-300">
          ¿Listo para transformar tu atención al cliente? Hablemos
        </p>
      </div>
      
      <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 p-8">
  <form id="contact-form" class="space-y-6" novalidate action="https://paneln8n.erickpinargote.com/webhook/contacto_pynark" method="POST">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                Nombre
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                placeholder="Tu nombre completo"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                Email
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                placeholder="tu@email.com"
              />
            </div>
          </div>
          
          <div>
            <label for="company" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Empresa
            </label>
            <input
              type="text"
              id="company"
              name="company"
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              placeholder="Nombre de tu empresa"
            />
          </div>
          
          <div>
            <label for="message" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
              Mensaje
            </label>
            <textarea
              id="message"
              name="message"
              rows="4"
              required
              class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
              placeholder="Cuéntanos sobre tu proyecto y cómo podemos ayudarte..."
            ></textarea>
          </div>
          
          <div class="space-y-4">
            <div id="contact-status" class="text-sm" aria-live="polite"></div>
            <button
              id="contact-submit"
              type="submit"
              class="w-full px-8 py-4 bg-gradient-to-r from-primary-600 to-secondary-600 hover:from-primary-700 hover:to-secondary-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 disabled:opacity-60 disabled:cursor-not-allowed"
            >
              Enviar mensaje
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script>
    // Prevent initial unwanted scroll
    document.addEventListener('DOMContentLoaded', () => {
      // Reset scroll position if no specific hash is intended
      if (!window.location.hash || window.location.hash === '#') {
        window.scrollTo(0, 0);
      }
    });

    // Chat section interactivity
    const showAgentsBtn = document.getElementById('show-agents-btn');
    const agentButtons = document.getElementById('agent-buttons');
  const ecommerceBtn = document.getElementById('ecommerce-btn');
  const drivingBtn = document.getElementById('driving-btn');
  const chatContainer = document.getElementById('chat-container');
  const chatEcommerce = document.getElementById('chat-ecommerce');
  const chatDriving = document.getElementById('chat-driving');

    showAgentsBtn?.addEventListener('click', () => {
      showAgentsBtn.style.display = 'none';
      agentButtons?.classList.remove('hidden');
    });

  function showChat(which: 'ecommerce' | 'driving') {
      if (!chatContainer || !chatEcommerce || !chatDriving) return;
      agentButtons?.classList.add('hidden');
      chatContainer.classList.remove('hidden');
      // Hide both, show selected
      chatEcommerce.classList.add('hidden');
      chatDriving.classList.add('hidden');
      if (which === 'ecommerce') {
        chatEcommerce.classList.remove('hidden');
      } else if (which === 'driving') {
        chatDriving.classList.remove('hidden');
      }
    }

    ecommerceBtn?.addEventListener('click', () => showChat('ecommerce'));
    drivingBtn?.addEventListener('click', () => showChat('driving'));

  // Nota: se eliminó el placeholder de envío de formularios para no interferir con el formulario del chat
  // --- Contact form submission to n8n webhook ---
  (function initContactForm(){
    const form = document.getElementById('contact-form') as HTMLFormElement | null;
    if(!form) return;
    const statusEl = document.getElementById('contact-status');
    const submitBtn = document.getElementById('contact-submit') as HTMLButtonElement | null;
    const WEBHOOK_URL = 'https://paneln8n.erickpinargote.com/webhook/contacto_pynark';

    // Optional simple honeypot
    if(!form.querySelector('[name="_hp"]')){
      const hp = document.createElement('input');
      hp.type = 'text';
      hp.name = '_hp';
      hp.tabIndex = -1;
      hp.autocomplete = 'off';
      hp.style.position = 'absolute';
      hp.style.left = '-9999px';
      form.appendChild(hp);
    }

    const setStatus = (msg: string, type: 'info'|'success'|'error') => {
      if(!statusEl) return;
      const base = 'px-4 py-3 rounded-lg border text-sm font-medium';
      const styles: Record<string,string> = {
        info: 'bg-slate-100 dark:bg-slate-700/50 text-slate-700 dark:text-slate-200 border-slate-300 dark:border-slate-600',
        success: 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-200 border-emerald-300 dark:border-emerald-700',
        error: 'bg-rose-100 dark:bg-rose-900/30 text-rose-800 dark:text-rose-200 border-rose-300 dark:border-rose-700'
      };
      statusEl.className = base + ' ' + styles[type];
      statusEl.textContent = msg;
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(submitBtn?.disabled) return; // prevent double
      const formData = new FormData(form);
      // Honeypot detection
      if((formData.get('_hp') as string)?.trim().length){
        setStatus('Enviado', 'success'); // Pretend success to bots
        return;
      }
      const name = (formData.get('name')||'').toString().trim();
      const email = (formData.get('email')||'').toString().trim();
      const company = (formData.get('company')||'').toString().trim();
      const message = (formData.get('message')||'').toString().trim();

      if(!name || !email || !message){
        setStatus('Por favor completa los campos requeridos.', 'error');
        return;
      }

      const payload = {
        name,
        email,
        company: company || null,
        message,
        submitted_at: new Date().toISOString(),
        source: 'website_contact_form',
        user_agent: navigator.userAgent
      };

      try {
        submitBtn && (submitBtn.disabled = true);
        setStatus('Enviando tu mensaje...', 'info');
        const resp = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!resp.ok){
          throw new Error('Status ' + resp.status);
        }
        setStatus('¡Mensaje enviado! Te contactaremos muy pronto.', 'success');
        form.reset();
        // Foco accesible
        setTimeout(() => { statusEl?.scrollIntoView({behavior:'smooth', block:'center'}); }, 50);
      } catch(err){
        console.error('Error enviando formulario', err);
        setStatus('No se pudo enviar. Intenta nuevamente en unos segundos.', 'error');
      } finally {
        submitBtn && (submitBtn.disabled = false);
      }
    });
  })();
  </script>

  <style>
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .animate-fade-in {
      animation: fade-in 0.5s ease-out forwards;
    }
    
  </style>
</Layout>
